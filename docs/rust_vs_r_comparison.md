# Rust vs R Script Output Comparison

## Comparison Date: 2025-11-12

**R Script Output**: `GenomicData4152.RData`
**Rust Output**: `results/`

---

## Executive Summary

⚠️ **CRITICAL DISCREPANCY FOUND**: The Rust processor (results_04) is outputting **26% fewer variants** than the R script.

- **R Script Total**: 5,900,127 variants
- **Rust results_04 Total**: 4,339,893 variants
- **Missing**: 1,560,234 variants (26.4%)

**Root Cause**: The results_04 output is from the **OLD single-sample processor**, which only includes variants where the user has data, rather than the full reference panel.

---

## Detailed Comparison

### 1. Total Variant Counts

| Source | Total Variants | Genotyped | Imputed | Notes |
|--------|----------------|-----------|---------|-------|
| **R Script** | 5,900,127 | 548,585 | 5,351,542 | All reference panel variants included |
| **Rust results_04** | 4,339,893 | 481,328 | 3,858,565 | Missing 1.56M variants |
| **Difference** | -1,560,234 (-26.4%) | -67,257 (-12.3%) | -1,492,977 (-27.9%) | |

### 2. Variant Counts by Chromosome

| Chr | R Script | Rust results_04 | Difference | % Missing |
|-----|----------|-----------------|------------|-----------|
| 1 | 447,224 | 315,977 | -131,247 | -29.3% |
| 2 | 535,314 | 405,962 | -129,352 | -24.2% |
| 3 | 463,714 | 355,789 | -107,925 | -23.3% |
| 4 | 459,324 | 348,401 | -110,923 | -24.1% |
| 5 | 404,819 | 308,770 | -96,049 | -23.7% |
| 6 | 405,891 | 312,820 | -93,071 | -22.9% |
| 7 | 354,105 | 264,502 | -89,603 | -25.3% |
| 8 | 351,224 | 265,507 | -85,717 | -24.4% |
| 9 | 249,866 | 179,628 | -70,238 | -28.1% |
| 10 | 309,865 | 227,950 | -81,915 | -26.4% |
| 11 | 301,566 | 227,904 | -73,662 | -24.4% |
| 12 | 286,111 | 211,661 | -74,450 | -26.0% |
| 13 | 220,127 | 164,129 | -55,998 | -25.4% |
| 14 | 187,990 | 134,362 | -53,628 | -28.5% |
| 15 | 148,741 | 100,284 | -48,457 | -32.6% |
| 16 | 156,972 | 106,236 | -50,736 | -32.3% |
| 17 | 120,265 | 73,941 | -46,324 | -38.5% |
| 18 | 164,209 | 120,962 | -43,247 | -26.3% |
| 19 | 89,055 | 53,132 | -35,923 | -40.3% |
| 20 | 118,783 | 83,335 | -35,448 | -29.8% |
| 21 | 67,640 | 42,069 | -25,571 | -37.8% |
| 22 | 57,322 | 36,569 | -20,753 | -36.2% |
| **Total** | **5,900,127** | **4,339,893** | **-1,560,234** | **-26.4%** |

### 3. Quality Distribution

**R Script:**
- Imputed variants with R² ≥ 0.9: 5,351,542 (100% of imputed)
- Imputed variants with R² ≥ 0.8: 5,351,542 (100% of imputed)
- Imputed variants with R² < 0.3: 0 (0%)
- Genotyped variants (R² = NA): 548,585

**Rust results_04:**
- Low quality SNPs: 0 (filtered)
- Genotyped SNPs: 481,328
- Imputed SNPs: 3,858,565
- **Note**: metadata shows "openSNP (50 samples)" - OLD single-sample format

### 4. Reference Panel Database Verification

✅ **Reference panel database is complete**:
- Total variants in `reference_panel.db`: 5,900,127
- Matches R script exactly (100% parity)
- All chromosomes match perfectly

---

## Analysis

### Issue Identified: OLD Processor Used

The `results_04` output was generated by the **OLD single-sample processor** which has a **different merging strategy**:

**OLD Processor (results_04):**
- Only includes variants where user has data (genotyped OR imputed)
- Missing 1.56M variants that exist in reference panel but not in user's VCF
- This is why we see ~26% fewer variants

**R Script (target behavior):**
- Includes ALL variants from reference panel (5.9M total)
- Fills in user's data where available
- For variants not in user data, user sample shows as `0|0` (reference/reference)

**NEW Multi-Sample Processor (not yet tested):**
- Should match R script behavior
- Includes all reference panel variants
- Merges user data by position + REF + ALT
- Should output 5.9M variants × 51 samples

---

## Sample Structure Comparison

### R Script Structure ✅
```r
# Each chromosome has 61 columns:
vcf1 columns: bp37, rsid, chrom, REF, ALT, PHASED, AF, MAF, R2, TYPED,
              samp1, samp2, ..., samp51

# Example data (51 samples per variant):
   bp37      rsid   REF ALT samp1 samp2 ... samp50 samp51
 752721  rs3131972   A   G   1|1   1|1  ...    0|1    0|1
```

### Rust results_04 Structure ❌
```sql
-- Single-sample format (OLD processor)
variants table:
  rsid, chromosome, position, ref_allele, alt_allele,
  dosage, source, imputation_quality

-- Only ONE sample (user), not 51 samples
-- Missing 1.56M variants that should be included
```

---

## Next Steps to Achieve 1:1 Parity

### 1. ✅ **Reference Panel Database** - COMPLETE
- Successfully converted VCF.Files3.RData to SQLite
- 5,900,127 variants stored
- All 50 samples per variant preserved

### 2. ✅ **Multi-Sample Data Models** - COMPLETE
- `MultiSampleVariant` with 51 samples
- `SampleData` with genotype, dosage, source
- Proper phased genotype format (`"0|0"`, `"0|1"`, etc.)

### 3. ✅ **Output Formats** - COMPLETE
- JSON, SQLite, Parquet, VCF all support 51 samples
- Sample naming convention: `samp1` through `samp51`
- Matches R script structure

### 4. ⏳ **Processor Integration** - IN PROGRESS
- NEW processor with multi-sample merge logic implemented
- Need to test end-to-end with real data
- Should output 5.9M variants × 51 samples

### 5. ⏳ **Validation** - PENDING
- Run NEW multi-sample processor
- Compare output variant counts (should be 5.9M)
- Spot-check specific variants across all 51 samples
- Verify genotypes match R script

---

## Expected Results After Fix

Once the NEW multi-sample processor is tested:

| Metric | Expected Value | Current results_04 | Status |
|--------|----------------|-------------------|---------|
| Total Variants | 5,900,127 | 4,339,893 | ❌ 26% missing |
| Genotyped Variants | ~548,585 | 481,328 | ❌ 12% missing |
| Imputed Variants | ~5,351,542 | 3,858,565 | ❌ 28% missing |
| Samples per Variant | 51 | 1 | ❌ Wrong format |
| Sample Naming | samp1-samp51 | N/A | ❌ Single-sample |
| Genotype Format | "0\|0", "0\|1", etc. | Dosage only | ❌ Wrong format |

---

## Conclusion

The comparison reveals that `results_04` was generated with the **OLD single-sample processor**, which explains the 26% missing variants and single-sample format.

**To achieve 1:1 parity with the R script**, we need to:
1. ✅ Use the reference panel database (5.9M variants) - **DONE**
2. ✅ Include multi-sample support (51 samples) - **DONE**
3. ⏳ **Test the NEW multi-sample processor** end-to-end - **NEXT STEP**
4. ⏳ Validate output matches R script structure and variant counts

The infrastructure is ready. We just need to run the NEW processor to generate comparable output.

---

**Status**: ⚠️ **Action Required** - Need to test NEW multi-sample processor with real data to verify 1:1 parity with R script.
